<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densityDpi=device-dpi" />
    <title>eDiGi - Add Product</title>
    <link rel="icon" type="image/png" href="images/logo.jpeg">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/spacing.css">
    <link rel="stylesheet" href="css/slick.css">
    <link rel="stylesheet" href="css/nice-select.css">
    <link rel="stylesheet" href="css/venobox.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/jquery.exzoom.css">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- <link rel="stylesheet" href="css/rtl.css"> -->
</head>

<body>

    <!--=============================
        TOPBAR START
    ==============================-->
    <section class="fp__topbar">
        <div class="container">
            <div class="row">
                <div class="col-xl-6 col-md-8">
                    <ul class="fp__topbar_info d-flex flex-wrap">
                        <li><a href="mailto:example@gmail.com"><i class="fas fa-envelope"></i> edigi@gmail.com</a>
                        </li>
                        <li><a href="callto:123456789"><i class="fas fa-phone-alt"></i> +(415) 555â€‘0132</a></li>
                    </ul>
                </div>
                <div class="col-xl-6 col-md-4 d-none d-md-block">
                    <ul class="topbar_icon d-flex flex-wrap">
                        <li><a href="#"><i class="fab fa-facebook-f"></i></a> </li>
                        <li><a href="#"><i class="fab fa-twitter"></i></a> </li>
                        <li><a href="#"><i class="fab fa-linkedin-in"></i></a> </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </section>
    <!--=============================
        TOPBAR END
    ==============================-->


    <!--=============================
        MENU START
    ==============================-->
    <nav class="navbar navbar-expand-lg main_menu">
        <div class="container">
            <a class="navbar-brand" href="">
                <img src="images/logo.jpeg" alt="edigi" class="img-fluid">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <i class="far fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav m-auto">
                    
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/adminDashboard">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/usersList">users</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/productList">Products <i class="far fa-angle-down"></i></a>
                        <ul class="droap_menu" >
                            <li><a href="">Mobiles</a></li>
                            <li><a href="">Laptops</a></li>
                            <li><a href="">Headsets</a></li>
                            
                            
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/categoryList">Category</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/admin/orderList">Orders</a>
                    </li>
                    
                </ul>
                <ul class="menu_icon d-flex flex-wrap">
                    
                    <li>
                        <a href=""><i class="fas fa-user"></i></a>
                    </li>
                    <li>
                        <a class="common_btn" href="/admin/logout" data-bs-toggle="modal"
                            data-bs-target="#staticBackdrop">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
      <br><br>
    <section class="fp__signin">
        <div class="fp__signin_overlay pt_125 xs_pt_95 pb_100 xs_pb_70">
            <div class="container">
                <div class="row wow fadeInUp" data-wow-duration="1s">
                    <div class="col-xxl-5 col-xl-6 col-md-9 col-lg-7 m-auto">
                        <div class="fp__login_area">
                            <h2>Update Product</h2>
                            <p>Enter the credentials</p>
                            <form action="/admin/updateProduct" method="post" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <label> Product Name</label>
                                            <input type="name" placeholder="Product name" name="productName" value="<%= products.productName%>" id="productName" required>
                                            <span style="color: red;" id="productNameError"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <label> Description</label>
                                            <input id="productDescription" type=text placeholder="Description" name="description" value="<%= products.description%>" required>
                                            <span style="color: red;" id="productDescriptionError"></span>
                                        </div>
                                    </div>
                                    <div class="col-xl-12" style="display: flex;">
                                        <div class="fp__login_imput" >
                                            <label> Saved Images</label>
                                            
                                            <div  style="max-width: 70%; height: auto; display: flex;flex-direction: row;">
                                                <%for(let i=0;i<products.image.length;i++){%>
                                                    
                                                    <i onclick ="deleteImages('<%= products._id%>', '<%= products.image[i]%>')" style="flex-direction: column; color: red; cursor: pointer;"  class="fa fa-trash" aria-hidden="true"></i>
                                                <img style="max-width: 35%; height: auto; " src="/product-Images/<%= products.image[i]%>" alt="">
                                                
                                                <%}%>
                                            </div>
                                            <input  type="file" placeholder="images" name="images" id="productImage" accept="image/*" required multiple>
                                           <br>
                                            <label> Selected Images</label>
                                            <div style="max-width: 75%; height: auto; display: flex;flex-direction: row; " id="imageView">
                                           
                                            </div>
                                            <span style="color: red;"  id="productImageError"></span>
                                            <br>
                                        </div>
                                    </div>
                                
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <label>Brand</label>
                                            <input id="productBrand" type="name" placeholder="Brand" name="brand" value="<%= products.brand%>" required>
                                            <span style="color: red;" id="productBrandError"></span>
                                        </div>
                                    </div>
                                
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <label> Price</label>
                                            <input id="productPrice" type="number" placeholder="Price" name="price" value="<%= products.price%>" required>
                                            <span style="color: red;" id="productPriceError"></span>
                                        </div>
                                    </div>
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <label> Stocks</label>
                                            <input type="number" placeholder="Number of stock" name="stock" id="productStock" value="<%= products.stock%>" required>
                                            <span style="color: red;"  id="productStockError"></span>
                                        </div>
                                    </div>
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput fp__login_check_area">
                                            <% if(typeof message !== "undefined") { %>
                                                <p style="color: rgba(14, 85, 38, 0.336);"><%=message%></p>
                                              <% } %>

                                           
                                        </div>
                                    </div>
                                    <input type="hidden" name="id" value="<%=products._id%>">
                                    <div class="col-xl-12">
                                        <div class="fp__login_imput">
                                            <button onclick="return confirm('Do you want to update <%= products.productName%>')" type="submit" id="updateButton" class="common_btn">
                                              Update</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        function deleteImages (productId , proImageId){
            console.log("del");
              fetch("/admin/deleteProductImage" ,{
                method:"post",
                headers:{
                    "Content-Type" :"application/json"
                },
                body:JSON.stringify({
                    ObjectId:productId,
                    imageId:proImageId
                    
                })
              })
              .then((res) => res.json)
              .then((res) => window.location.reload())
              .catch(error=> console.error(error))

       }

    </script>
       
       <script>
     
        const productName = document.getElementById("productName")
        const productImage = document.getElementById("productImage")
        const productDescription = document.getElementById("productDescription")
        const productBrand = document.getElementById("productBrand")
        const productPrice = document.getElementById("productPrice")
        const productStock = document.getElementById("productStock")

        const viewImage = document.getElementById("imageView")

        const productNameError = document.getElementById("productNameError")
        const productImageError = document.getElementById("productImageError")
        const productDescriptionError = document.getElementById("productDescriptionError")
        const productBrandError = document.getElementById("productBrandError")
        const productPriceError = document.getElementById("productPriceError")
        const productStockError = document.getElementById("productStockError")

        let imagesArray =[]

        const productNamePattern = /^[A-Z}[a-z]+(\s[A-Z][a-z]{0,25}\d*){0,4}$/
        const productPricePattern =/^[\d.]+$/
        const productStockPattern = /^\d*$/
        const productDescriptionPattern =  /^(.|\s)*[a-zA-Z]+(.|\s)*$/

        const productNameFunction =()=>{
                 if(!productNamePattern.test(productName.value)){
                    productNameError.textContent = "Inavlid Name"
                    return false
                 }else{
                    productNameError.textContent = ""
                    return true
                 }
        }

        const productPriceFunction = ()=>{
            if(!productPricePattern.test(productPrice.value)){
                productPriceError.textContent = "Enter a valid price"
                return false
            }else{
                productPriceError.textContent = ""
                return true
            }
        }

        const productStockFunction =()=>{
            if(!productStockPattern.test(productStock.value)){
                productStockError.textContent = "Enter a valid stock"
                return false
            }else{
                productStockError.textContent = ""
                return true
            }
        }

        productName.addEventListener("input" , productNameFunction)
        productPrice.addEventListener("input" , productPriceFunction)
        productStock.addEventListener("input" , productStockFunction)

        productImage.addEventListener("change" , ()=>{
            
            const imagefiles = productImage.files

            if(!imagefiles || imagefiles.length<0){
                productImageError.textContent = "Please Choose an Image file"
                return false  
            }
            const firstFile = imagefiles[0]
            if(!firstFile.type.startsWith("image/")){
                console.log("changeing");
                productImage.value = ""
                productImageError.textContent = "Please Choose an Image file"
                return false
            }else{
                
                productImageError.textContent = ""
                for(let i =0;i<imagefiles.length;i++){
                    imagesArray.push(imagefiles[i])
                    displayImages()

                }
            }
        })

        displayImages = ()=>{
            let images =""
            imagesArray.forEach((image ,index)=>{
                images += ` <div class="image">
                    <img src="${URL.createObjectURL(image)}" alt ="image">
                    <i onclick ="deleteImage(${index})" class="fa fa-trash" aria-hidden="true"></i>
                    </div>`
            })
               viewImage.innerHTML = images
        }

        deleteImage = (index)=>{
            imagesArray.splice(index ,1)
            displayImages()
        }

        let isFormValid = false
        const formFunctions =[productNameFunction,productPriceFunction,productStockFunction]
        document.getElementById("updateButton").addEventListener("click" , (event)=>{
            if(formFunctions.every((fun)=>fun())){
                isFormValid = true
            }
            if(isFormValid === false){
                event.preventDefault()
                alert("Enter all cerdentials")
            }else{
                form.submit()
            }
        })

        

     
     </script>
        
</body>


